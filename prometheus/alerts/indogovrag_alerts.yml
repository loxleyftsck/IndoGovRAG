groups:
  - name: indogovrag_latency_alerts
    interval: 30s
    rules:
      # P95 latency exceeds SLO
      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, rate(indogovrag_query_latency_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High P95 latency detected"
          description: "P95 latency is {{ $value }}s (threshold: 30s)"

      # P99 latency critical
      - alert: CriticalLatencyP99
        expr: histogram_quantile(0.99, rate(indogovrag_query_latency_seconds_bucket[5m])) > 60
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Critical P99 latency"
          description: "P99 latency is {{ $value }}s (threshold: 60s)"

      # LLM latency too high
      - alert: SlowLLMGeneration
        expr: histogram_quantile(0.95, rate(indogovrag_llm_latency_seconds_bucket[5m])) > 40
        for: 5m
        labels:
          severity: warning
          component: llm
        annotations:
          summary: "LLM generation slow"
          description: "LLM P95 latency: {{ $value }}s"

  - name: indogovrag_error_alerts
    interval: 30s
    rules:
      # Error rate above warning threshold
      - alert: HighErrorRate
        expr: |
          sum(rate(indogovrag_queries_total{status!="success"}[5m])) 
          / 
          sum(rate(indogovrag_queries_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate: {{ $value | humanizePercentage }} (threshold: 5%)"

      # Error rate critical
      - alert: CriticalErrorRate
        expr: |
          sum(rate(indogovrag_queries_total{status!="success"}[5m])) 
          / 
          sum(rate(indogovrag_queries_total[5m])) > 0.10
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "CRITICAL: Very high error rate"
          description: "Error rate: {{ $value | humanizePercentage }} (threshold: 10%)"

      # No successful queries (API down?)
      - alert: NoSuccessfulQueries
        expr: rate(indogovrag_queries_total{status="success"}[5m]) == 0
        for: 5m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "No successful queries"
          description: "API may be down or all queries failing"

  - name: indogovrag_cost_alerts
    interval: 1m
    rules:
      # High cost per query
      - alert: HighQueryCost
        expr: histogram_quantile(0.95, rate(indogovrag_query_cost_usd_bucket[5m])) > 0.05
        for: 10m
        labels:
          severity: warning
          component: cost
        annotations:
          summary: "High cost per query"
          description: "P95 cost: ${{ $value }} (threshold: $0.05)"

      # Critical cost spike
      - alert: CostSpike
        expr: histogram_quantile(0.99, rate(indogovrag_query_cost_usd_bucket[5m])) > 0.10
        for: 5m
        labels:
          severity: critical
          component: cost
        annotations:
          summary: "CRITICAL: Cost spike detected"
          description: "P99 cost: ${{ $value }} (threshold: $0.10)"

  - name: indogovrag_quality_alerts
    interval: 5m
    rules:
      # RAGAS faithfulness below threshold
      - alert: LowFaithfulness
        expr: indogovrag_ragas_faithfulness < 0.70
        for: 10m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "Low RAGAS faithfulness score"
          description: "Faithfulness: {{ $value }} (threshold: 0.70)"

      # RAGAS faithfulness critical
      - alert: CriticalFaithfulness
        expr: indogovrag_ragas_faithfulness < 0.60
        for: 5m
        labels:
          severity: critical
          component: quality
        annotations:
          summary: "CRITICAL: Very low faithfulness"
          description: "Faithfulness: {{ $value }} - possible hallucinations"

      # Low retrieval confidence
      - alert: LowRetrievalConfidence
        expr: histogram_quantile(0.50, rate(indogovrag_retrieval_confidence_bucket[10m])) < 0.50
        for: 15m
        labels:
          severity: warning
          component: retrieval
        annotations:
          summary: "Low retrieval confidence"
          description: "Median confidence: {{ $value }} (threshold: 0.50)"
